{% extends 'base.html' %}
{% load static %}

{% block title %}Armamento - AgriSecure{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Armamento Sistema</h1>
        <p class="text-gray-500">Gestisci lo stato di sicurezza del sistema</p>
    </div>
    
    <!-- Current Status -->
    <div class="rounded-xl p-6 {% if is_armed %}bg-green-50 border border-green-200{% else %}bg-yellow-50 border border-yellow-200{% endif %}">
        <div class="flex items-center space-x-4">
            <div class="p-4 rounded-full {% if is_armed %}bg-green-100{% else %}bg-yellow-100{% endif %}">
                {% if is_armed %}
                <i data-lucide="shield" class="w-8 h-8 text-green-600"></i>
                {% else %}
                <i data-lucide="shield-off" class="w-8 h-8 text-yellow-600"></i>
                {% endif %}
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-900">
                    {% if is_armed %}Sistema ARMATO{% else %}Sistema DISARMATO{% endif %}
                </h2>
                {% if is_armed and current_state.mode %}
                <p class="text-gray-600">
                    Modalità: 
                    {% if current_state.mode == 'away' %}Fuori Casa
                    {% elif current_state.mode == 'home' %}In Casa
                    {% elif current_state.mode == 'night' %}Notte
                    {% else %}{{ current_state.mode }}{% endif %}
                </p>
                {% endif %}
                {% if current_state.changed_at %}
                <p class="text-sm text-gray-500">
                    Ultimo cambio: {{ current_state.changed_at|date:"d/m/Y H:i" }}
                </p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Quick Disarm -->
    {% if is_armed %}
    <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="font-semibold text-gray-900">Disarma Sistema</h3>
                <p class="text-sm text-gray-500">Disattiva tutti i sensori di sicurezza</p>
            </div>
            <form method="post" action="{% url 'frontend:arm_action' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="disarm">
                <button type="submit" class="px-6 py-3 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 flex items-center">
                    <i data-lucide="unlock" class="w-5 h-5 mr-2"></i>
                    DISARMA
                </button>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- Arm Controls -->
    {% if not is_armed %}
    <form method="post" action="{% url 'frontend:arm_action' %}" class="bg-white rounded-xl shadow-sm p-6 space-y-6">
        {% csrf_token %}
        <input type="hidden" name="action" value="arm">
        
        <h3 class="font-semibold text-gray-900">Arma Sistema</h3>
        
        <!-- Mode Selection -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-3">Seleziona modalità:</label>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <label class="cursor-pointer">
                    <input type="radio" name="mode" value="away" class="sr-only peer" checked>
                    <div class="p-6 rounded-xl border-2 border-gray-200 peer-checked:border-agri-500 peer-checked:bg-agri-50 transition-all">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 rounded-lg bg-gray-100 peer-checked:bg-agri-100">
                                <i data-lucide="lock" class="w-6 h-6 text-gray-500"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Fuori Casa</h4>
                                <p class="text-sm text-gray-500">Tutti i sensori attivi</p>
                            </div>
                        </div>
                    </div>
                </label>
                
                <label class="cursor-pointer">
                    <input type="radio" name="mode" value="home" class="sr-only peer">
                    <div class="p-6 rounded-xl border-2 border-gray-200 peer-checked:border-agri-500 peer-checked:bg-agri-50 transition-all">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 rounded-lg bg-gray-100 peer-checked:bg-agri-100">
                                <i data-lucide="shield" class="w-6 h-6 text-gray-500"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">In Casa</h4>
                                <p class="text-sm text-gray-500">Solo perimetro esterno</p>
                            </div>
                        </div>
                    </div>
                </label>
                
                <label class="cursor-pointer">
                    <input type="radio" name="mode" value="night" class="sr-only peer">
                    <div class="p-6 rounded-xl border-2 border-gray-200 peer-checked:border-agri-500 peer-checked:bg-agri-50 transition-all">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 rounded-lg bg-gray-100 peer-checked:bg-agri-100">
                                <i data-lucide="moon" class="w-6 h-6 text-gray-500"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Notte</h4>
                                <p class="text-sm text-gray-500">Perimetro + zone selezionate</p>
                            </div>
                        </div>
                    </div>
                </label>
            </div>
        </div>
        
        <!-- Node Selection -->
        {% if security_nodes %}
        <div>
            <div class="flex items-center justify-between mb-3">
                <label class="block text-sm font-medium text-gray-700">Seleziona nodi da armare:</label>
                <button type="button" onclick="toggleAllNodes()" class="text-sm text-agri-600 hover:text-agri-700">
                    Seleziona/Deseleziona tutti
                </button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                {% for node in security_nodes %}
                <label class="flex items-center p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" name="nodes" value="{{ node.node_id }}" class="node-checkbox w-4 h-4 text-agri-600 rounded" checked>
                    <div class="ml-3 flex-1">
                        <span class="font-medium text-gray-900">{{ node.name|default:node.node_id }}</span>
                        <span class="ml-2 text-xs {% if node.status == 'online' %}text-green-600{% else %}text-red-600{% endif %}">
                            ({{ node.status }})
                        </span>
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="flex items-center p-4 bg-yellow-50 rounded-lg text-yellow-700">
            <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
            Nessun nodo di sicurezza configurato
        </div>
        {% endif %}
        
        <!-- Notes -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Note (opzionale):</label>
            <textarea name="notes" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-agri-500" placeholder="Es: Armato per la notte"></textarea>
        </div>
        
        <!-- Arm Button -->
        <button type="submit" class="w-full py-4 bg-agri-600 text-white font-semibold rounded-lg hover:bg-agri-700 flex items-center justify-center">
            <i data-lucide="lock" class="w-5 h-5 mr-2"></i>
            ARMA SISTEMA
        </button>
    </form>
    {% endif %}
    
    <!-- Armed Nodes List -->
    {% if is_armed and armed_nodes %}
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="font-semibold text-gray-900 mb-4">Nodi Armati</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
            {% for node in armed_nodes %}
            <div class="flex items-center p-3 bg-green-50 rounded-lg">
                <i data-lucide="radio" class="w-4 h-4 text-green-600 mr-2"></i>
                <span class="text-green-800">{{ node.name|default:node.node_id }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleAllNodes() {
        const checkboxes = document.querySelectorAll('.node-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }
</script>
{% endblock %}
