; PlatformIO Project Configuration File
; AgriSecure IoT System - Firmware per ESP32-C6
;
; Prototipo 3 Nodi:
; - NODE_GATEWAY: Gateway con 4G/LTE
; - NODE_AMBIENT: Sensori ambientali
; - NODE_SECURITY: Sicurezza perimetrale

[platformio]
default_envs = node_gateway
src_dir = src
include_dir = include
lib_dir = lib
test_dir = test

; ============================================================
; Configurazione comune a tutti i nodi
; ============================================================
[env]
platform = espressif32
board = esp32-c6-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600

; Partizioni per OTA
board_build.partitions = min_spiffs.csv

; Flags di compilazione comuni
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; Versione firmware
    -DFIRMWARE_VERSION=\"1.0.0\"
    -DFIRMWARE_BUILD_DATE=\"${UNIX_TIME}\"
    ; Configurazione mesh
    -DMESH_CHANNEL=1
    -DMESH_MAX_NODES=25
    -DMESH_HEARTBEAT_INTERVAL=1800000
    ; Encryption key (32 bytes hex) - CAMBIARE IN PRODUZIONE!
    -DMESH_ENCRYPTION_KEY=\"0123456789ABCDEF0123456789ABCDEF\"

; Librerie comuni
lib_deps = 
    bblanchon/ArduinoJson@^7.0.0
    knolleary/PubSubClient@^2.8
    256dpi/MQTT@^2.5.0

; ============================================================
; NODO GATEWAY - Connettivit√† 4G/Internet
; ============================================================
[env:node_gateway]
build_flags = 
    ${env.build_flags}
    -DNODE_TYPE=NODE_GATEWAY
    -DNODE_ID=\"GW-001\"
    ; Configurazione 4G
    -DMODEM_RST=5
    -DMODEM_PWRKEY=4
    -DMODEM_TX=17
    -DMODEM_RX=18
    ; MQTT
    -DMQTT_BROKER=\"mqtt.agrisecure.local\"
    -DMQTT_PORT=1883
    -DMQTT_USER=\"agrisecure\"
    -DMQTT_PASS=\"secure_password_here\"
    ; GPS
    -DGPS_ENABLED=1

lib_deps = 
    ${env.lib_deps}
    vshymanskyy/TinyGSM@^0.11.7
    mikalhart/TinyGPSPlus@^1.0.3

; ============================================================
; NODO AMBIENTALE - Monitoraggio clima/suolo
; ============================================================
[env:node_ambient]
build_flags = 
    ${env.build_flags}
    -DNODE_TYPE=NODE_AMBIENT
    -DNODE_ID=\"AMB-001\"
    ; Pin sensori
    -DBME280_SDA=6
    -DBME280_SCL=7
    -DSOIL_PIN=0
    -DBH1750_ADDR=0x23
    ; Intervallo letture (ms)
    -DSENSOR_READ_INTERVAL=600000
    ; Deep sleep
    -DDEEP_SLEEP_ENABLED=1
    -DDEEP_SLEEP_DURATION=600

lib_deps = 
    ${env.lib_deps}
    adafruit/Adafruit BME280 Library@^2.2.2
    adafruit/Adafruit Unified Sensor@^1.1.9
    claws/BH1750@^1.3.0

; ============================================================
; NODO SICUREZZA - Antintrusione perimetrale
; ============================================================
[env:node_security]
build_flags = 
    ${env.build_flags}
    -DNODE_TYPE=NODE_SECURITY
    -DNODE_ID=\"SEC-001\"
    ; Pin sensori
    -DPIR_MAIN_PIN=2
    -DPIR_BACKUP_PIN=3
    -DMPU6050_SDA=6
    -DMPU6050_SCL=7
    ; Pin attuatori
    -DRELAY_SIREN_PIN=10
    -DRELAY_LIGHT_PIN=11
    ; Soglie discriminazione
    -DPERSON_HEIGHT_MIN=120
    -DANIMAL_HEIGHT_MAX=80
    ; Allarme
    -DALARM_DURATION=30000
    -DALARM_COOLDOWN=60000

lib_deps = 
    ${env.lib_deps}
    electroniccats/MPU6050@^1.3.0

; ============================================================
; Ambiente di TEST/DEBUG
; ============================================================
[env:test_node]
build_flags = 
    ${env.build_flags}
    -DNODE_TYPE=NODE_TEST
    -DNODE_ID=\"TEST-001\"
    -DDEBUG_MODE=1
    -DSERIAL_DEBUG=1

lib_deps = 
    ${env.lib_deps}
    adafruit/Adafruit BME280 Library@^2.2.2
    adafruit/Adafruit Unified Sensor@^1.1.9
    claws/BH1750@^1.3.0
    electroniccats/MPU6050@^1.3.0
    vshymanskyy/TinyGSM@^0.11.7
